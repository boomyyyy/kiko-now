---
layout: post
title: "Java多线程学习一"
description: "Java 多线程基础"
date: 2017-12-18
tags: [Java,线程]
comments: true
share: true
---
## 相关概念

### 进程

> 英文名称 process，是计算机中已运行程序的实体。进程为曾经是分时系统的基本运作单位。在面向进程设计的系统（如早期的UNIX，Linux 2。4及更早的版本）中，进程是程序的基本执行实体；在面向线程设计的系统（如当代多数操作系统、Linux 2。6及更新的版本）中，进程本身不是基本运行单位，而是线程的容器。程序本身只是指令、数据及其组织形式的描述，进程才是程序（那些指令和数据）的真正运行实例。若干进程有可能与同一个程序相关系，且每个进程皆可以同步（循序）或异步（平行）的方式独立运行。现代计算机系统可在同一段时间内以进程的形式将多个程序加载到内存中，并借由时间共享（或称时分复用），以在一个处理器上表现出同时（平行性）运行的感觉。同样的，使用多线程技术（多线程即每一个线程都代表一个进程内的一个独立执行上下文）的操作系统或计算机架构，同样程序的平行线程，可在多CPU主机或网络上真正同时运行（在不同的CPU上）。参考 [维基百科](https://zh.wikipedia.org/wiki/线程)

### 线程

> 英文名称 thread，是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。在Unix System V及SunOS中也被称为轻量进程（lightweight processes），但轻量进程更多指内核线程（kernel thread），而把用户线程（user thread）称为线程。参考 [维基百科](https://zh.wikipedia.org/wiki/线程)

### 线程安全

> 当多个线程访问某个类时，这个类始终能表现出正确的行为，该定义摘自 《Java 并发实战》。个人理解便是通过代码便可以理解代码的执行顺序和结果，而中途不会出现奇奇怪怪的事情。

###  可见性

> 如果一个线程对共享变量值的修改，能够及时的被其他线程看到，叫做共享变量的可见性。如果一个变量同时在多个线程的工作内存中存在副本，那么这个变量就叫共享变量。

## 导致线程不安全的原因

![jmm.png](/images/2017-12-18-jmm.png)

了解线程不安全的原因首先要了解 java 内存模型，两条规定：

1. 线程对于共享变量的操作应该在工作内存中进行， 不允许直接操作主内存
2. 线程间不允许访问彼此工作内存中的变量，线程间变量的传递需要通过主内存
	
```java
public class ThreadTest {

    private int num;

    class AddThread implements Runnable {

        @Override
        public void run() {
            num++;
        }

    }

    public void test() {
        for (int i = 0; i < 16; i++) {
            new Thread(new AddThread()).start();
        }
    }

    public static void main(String[] args) {
        ThreadTest threadTest = new ThreadTest();
        threadTest.test();
        System.out.println(threadTest.num);
    }

}
```

理想情况下，最后应该输出16，但是多次运行你会先可能输出小于16的数字。

在创建的这16个线程中，每个线程都有自己工作内存，而这些线程又共享了num变量，当线程启动时，会从主内存中拷贝该变量至自己的工作内存中，随后每个线程会在自己的工作内存中操作该变量副本，最后会将该副本重新写会到主内存，替换原先变量的值。但在多个线程中，但由于线程间无法直接通信，这就导致变量的变化不能及时的反应在线程当中，这种细微的时间差最终导致每个线程当前操作的变量值未必是最新的，这就是所谓的内存不可见性。

## 如何保证线程安全

1. 修改变量为不可变变量
2. 不在线程间共享
3. 在访问变量时使用同步操作